let model_depth_encoder,model_depth_decoder;tf.setBackend("webgl"),tf.ENV.set("WEBGL_CONV_IM2COL",!1),tf.ENV.set("WEBGL_PACK",!1),tf.webgl.forceHalfFloat();var Depth_IMAGE_HEIGHT=192,Depth_IMAGE_WIDTH=320,output_HEIGHT=300,output_WIDTH=400,cors_api_url="https://cors-anywhere.herokuapp.com/";const status_depth=document.getElementById("status_depth"),dropdown_depth_qual=document.getElementById("dropdown_depth_qual"),depth_low=document.getElementById("depth_low"),depth_medium=document.getElementById("depth_medium"),depth_high=document.getElementById("depth_high");function is_touch_device(){return"ontouchstart"in window||"onmsgesturechange"in window}function set_static_output_size(t){t.clientWidth>t.naturalWidth&&t.clientHeight>t.naturalHeight?(output_HEIGHT=t.clientHeight,(output_WIDTH=Math.round(t.naturalWidth/t.naturalHeight*output_HEIGHT))>t.clientWidth&&(output_WIDTH=t.clientWidth,output_HEIGHT=Math.round(t.naturalHeight/t.naturalWidth*output_WIDTH))):t.clientWidth<t.naturalWidth&&t.clientHeight<t.naturalHeight?(output_WIDTH=t.clientWidth,(output_HEIGHT=Math.round(t.naturalHeight/t.naturalWidth*output_WIDTH))>t.clientHeight&&(output_HEIGHT=t.clientHeight,output_WIDTH=Math.round(t.naturalWidth/t.naturalHeight*output_HEIGHT))):t.clientWidth<t.naturalWidth?(output_WIDTH=t.clientWidth,output_HEIGHT=Math.round(t.naturalHeight/t.naturalWidth*output_WIDTH)):(output_HEIGHT=t.clientHeight,output_WIDTH=Math.round(t.naturalWidth/t.naturalHeight*output_HEIGHT))}function depth_file(t){if(status_depth.textContent="Status: Fetching image...",window.File&&window.FileReader&&window.FileList&&window.Blob){var e=new FileReader;e.addEventListener("load",(function(t){const e=t.target.result;window.loadImage(e,(function(t){"error"===t.type?console.log("couldn't load image:",t):window.EXIF.getData(t,(function(){var e=window.EXIF.getTag(this,"Orientation"),n=window.loadImage.scale(t,{orientation:e||0,canvas:!0});let o=document.getElementById("inpimg");o.src=n.toDataURL(),o.onload=()=>{set_static_output_size(o),Depth_Demo(o)}}))}))})),e.readAsDataURL(t)}else console.log("The File APIs are not fully supported in this browser.")}function custom_mgrid(t,e){return a=tf.tile(tf.range(0,t).reshape([t,1]),[1,e]),b=tf.tile(tf.range(0,e).expandDims(0),[t,1]),[a,b]}is_touch_device()||window.matchMedia("(max-device-width: 960px)").matches||(Depth_IMAGE_HEIGHT=192,Depth_IMAGE_WIDTH=640,dropdown_depth_qual.textContent=depth_high.textContent),document.getElementById("files").addEventListener("change",(function(t){depth_file(t.target.files[0])})),document.getElementById("depth_files_btn").addEventListener("click",(function(t){file=document.getElementById("files").files[0],null==file?status_depth.textContent="Status: File not found":depth_file(file)})),document.getElementById("btn").onclick=function(){status_depth.textContent="Status: Fetching image...";let t=new URL(document.getElementById("imagename").value);var e=new XMLHttpRequest;e.open("GET",cors_api_url+t,!0),e.responseType="blob",e.send(),e.onload=function(){var t=new FileReader;t.readAsDataURL(e.response),t.onload=t=>{let e=document.getElementById("inpimg");e.src=t.target.result,e.onload=()=>{set_static_output_size(e),Depth_Demo(e)}}}};const DepthWarmup=async()=>{status_depth.textContent="Status: Loading...",model_depth_encoder=await tf.loadLayersModel("/assets/tfjs_encoder_quant/model.json"),model_depth_decoder=await tf.loadLayersModel("/assets/tfjs_decoder_quant/model.json");let t=document.getElementById("inpimg");t.complete&&0!==t.naturalHeight?(set_static_output_size(t),Depth_Demo(t),t.style.display=""):t.onload=()=>{set_static_output_size(t),Depth_Demo(t),t.style.display=""},document.getElementById("file-container").style.display=""},Depth_Demo=async t=>{var e=0;status_depth.textContent="Status: Loading image into model...",in_img=tf.browser.fromPixels(t).toFloat();const n=tf.tidy(()=>{const n=tf.image.resizeBilinear(tf.browser.fromPixels(t).toFloat(),[Depth_IMAGE_HEIGHT,Depth_IMAGE_WIDTH]),o=tf.scalar(255),i=n.div(o);status_depth.textContent="Status: Model loaded! running inference";const a=i.transpose([2,0,1]).expandDims();var d=performance.now();const l=model_depth_encoder.predict(a),u=model_depth_decoder.predict(l);var c=performance.now();e=c-d;const r=u[3].squeeze(0).transpose([1,2,0]);return r.sub(r.min()).divNoNan(r.max().sub(r.min()))}),o=document.getElementById("depth");o.width=output_WIDTH,o.height=output_HEIGHT;const i=tf.image.resizeBilinear(n,[output_HEIGHT,output_WIDTH]);img_array=tf.image.resizeBilinear(in_img,[output_HEIGHT,output_WIDTH]).arraySync(),depth_array=i.arraySync(),await tf.browser.toPixels(i,o),status_depth.textContent="Status: Done! inference took "+e.toFixed(1)+" milliseconds.";const a=custom_mgrid(img_array.length,img_array[0].length);createPointCloud(a[0].arraySync(),a[1].arraySync(),depth_array,img_array)};depth_low.onclick=function(){event.preventDefault(),Depth_IMAGE_HEIGHT=96,Depth_IMAGE_WIDTH=320,dropdown_depth_qual.textContent=depth_low.textContent},depth_medium.onclick=function(){event.preventDefault(),Depth_IMAGE_HEIGHT=192,Depth_IMAGE_WIDTH=320,dropdown_depth_qual.textContent=depth_medium.textContent},depth_high.onclick=function(){event.preventDefault(),Depth_IMAGE_HEIGHT=192,Depth_IMAGE_WIDTH=640,dropdown_depth_qual.textContent=depth_high.textContent};var filecheckBox=document.getElementById("fileinput"),urlcheckBox=document.getElementById("urlinput"),filecontainer=document.getElementById("file-container"),urlcontainer=document.getElementById("url-container");filecheckBox.addEventListener("click",(function(){1==filecheckBox.checked?(urlcheckBox.checked=!1,filecontainer.style.display="block",urlcontainer.style.display="none"):(urlcheckBox.checked=!0,filecontainer.style.display="none",urlcontainer.style.display="block")})),urlcheckBox.addEventListener("click",(function(){1==urlcheckBox.checked?(filecheckBox.checked=!1,filecontainer.style.display="none",urlcontainer.style.display="block"):(filecheckBox.checked=!0,filecontainer.style.display="block",urlcontainer.style.display="none")})),DepthWarmup();