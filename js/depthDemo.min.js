let model_depth_encoder,model_depth_decoder;tf.setBackend("webgl");const input_res_lookup={outdoors1_low:[96,320],outdoors1_mid:[192,320],outdoors1_high:[192,640],outdoors2_low:[96,160],outdoors2_mid:[160,320],outdoors2_high:[320,640],indoors_low:[128,160],indoors_mid:[224,288],indoors_high:[416,544]},model_lookup={outdoors1:["/assets/tfjs_encoder_quant/model.json","/assets/tfjs_decoder_quant/model.json"],outdoors2:["/assets/kitti_citys_384_tfjs_encoder/model.json","/assets/kitti_citys_384_tfjs_decoder/model.json"],indoors:["/assets/nyud_keras_tfjs_encoder/model.json","/assets/nyud_keras_tfjs_decoder/model.json"]},norm_lookup={outdoors1:[[0,0,0],[1,1,1]],outdoors2:[[.485,.456,.406],[.229,.224,.225]],indoors:[[.485,.456,.406],[.229,.224,.225]]},out_idx={outdoors1:3,outdoors2:0,indoors:0};var curr_model="outdoors2",curr_res="mid",Depth_IMAGE_HEIGHT=192,Depth_IMAGE_WIDTH=320,output_HEIGHT=300,output_WIDTH=400,cors_api_url="https://cors-anywhere.herokuapp.com/";const status_depth=document.getElementById("status_depth"),dropdown_depth_qual=document.getElementById("dropdown_depth_qual"),depth_low=document.getElementById("depth_low"),depth_medium=document.getElementById("depth_medium"),depth_high=document.getElementById("depth_high");function is_touch_device(){return"ontouchstart"in window||"onmsgesturechange"in window}if(!is_touch_device()&&!window.matchMedia("(max-device-width: 960px)").matches){curr_res="high";dropdown_depth_qual.textContent=depth_high.textContent}function custom_mgrid(e,t){return a=tf.tile(tf.range(0,e).reshape([e,1]),[1,t]),b=tf.tile(tf.range(0,t).expandDims(0),[e,1]),[a,b]}document.getElementById("files").addEventListener("change",(function(e){file_infer(e.target.files[0],document.getElementById("inpimg"),status_depth,Depth_Demo)})),document.getElementById("depth_files_btn").addEventListener("click",(function(e){file=document.getElementById("files").files[0],null==file?status_depth.textContent="Status: File not found":file_infer(file,document.getElementById("inpimg"),status_depth,Depth_Demo)})),document.getElementById("btn").addEventListener("click",(function(e){url_infer(document.getElementById("imagename"),document.getElementById("inpimg"),status_depth,Depth_Demo)}));const update_model=async e=>{model_depth_encoder=await tf.loadLayersModel(model_lookup[e][0]),model_depth_decoder=await tf.loadLayersModel(model_lookup[e][1])},DepthWarmup=async()=>{status_depth.textContent="Status: Loading...",model_depth_encoder=await tf.loadLayersModel(model_lookup[curr_model][0]),model_depth_decoder=await tf.loadLayersModel(model_lookup[curr_model][1]);let e=document.getElementById("inpimg");e.complete&&0!==e.naturalHeight?(set_static_output_size(e),Depth_Demo(e),e.style.display=""):e.onload=()=>{set_static_output_size(e),Depth_Demo(e),e.style.display=""},document.getElementById("file-container").style.display=""},Depth_Demo=async e=>{status_depth.textContent="Status: Loading image into model...",output_WIDTH=e.clientWidth,output_HEIGHT=e.clientHeight,console.log(curr_model.concat("_").concat(curr_res)),Depth_IMAGE_WIDTH=input_res_lookup[curr_model.concat("_").concat(curr_res)][1],Depth_IMAGE_HEIGHT=input_res_lookup[curr_model.concat("_").concat(curr_res)][0],console.log(Depth_IMAGE_WIDTH),console.log(Depth_IMAGE_HEIGHT),in_img=tf.browser.fromPixels(e).toFloat();const t=tf.tidy(()=>{const e=tf.image.resizeBilinear(in_img,[Depth_IMAGE_HEIGHT,Depth_IMAGE_WIDTH]),t=tf.scalar(255),o=tf.tensor3d(norm_lookup[curr_model][0],[1,1,3]),n=tf.tensor3d(norm_lookup[curr_model][1],[1,1,3]),d=e.div(t).sub(o).div(n);status_depth.textContent="Status: Model loaded! running inference";const r=d.transpose([2,0,1]).expandDims(),i=model_depth_encoder.predict(r),c=model_depth_decoder.predict(i)[out_idx[curr_model]].squeeze(0).transpose([1,2,0]);return c.sub(c.min()).divNoNan(c.max().sub(c.min()))}),o=document.getElementById("depth");o.width=output_WIDTH,o.height=output_HEIGHT;const n=tf.image.resizeBilinear(t,[output_HEIGHT,output_WIDTH]);img_array=tf.image.resizeBilinear(in_img,[output_HEIGHT,output_WIDTH]).arraySync(),depth_array=n.arraySync(),await tf.browser.toPixels(n,o),status_depth.textContent="Status: Done!";const d=custom_mgrid(img_array.length,img_array[0].length);createPointCloud(d[0].arraySync(),d[1].arraySync(),depth_array,img_array),in_img.dispose(),t.dispose(),n.dispose()};scene_indoors.onclick=function(){event.preventDefault(),update_model(curr_model="indoors"),dropdown_scene.textContent=scene_indoors.textContent},scene_outdoors1.onclick=function(){event.preventDefault(),update_model(curr_model="outdoors1"),dropdown_scene.textContent=scene_outdoors1.textContent},scene_outdoors2.onclick=function(){event.preventDefault(),update_model(curr_model="outdoors2"),dropdown_scene.textContent=scene_outdoors2.textContent},depth_low.onclick=function(){event.preventDefault(),curr_res="low",dropdown_depth_qual.textContent=depth_low.textContent},depth_medium.onclick=function(){event.preventDefault(),curr_res="mid",dropdown_depth_qual.textContent=depth_medium.textContent},depth_high.onclick=function(){event.preventDefault(),curr_res="high",dropdown_depth_qual.textContent=depth_high.textContent};var filecheckBox=document.getElementById("fileinput"),urlcheckBox=document.getElementById("urlinput"),filecontainer=document.getElementById("file-container"),urlcontainer=document.getElementById("url-container");filecheckBox.addEventListener("click",(function(){1==filecheckBox.checked?(urlcheckBox.checked=!1,filecontainer.style.display="block",urlcontainer.style.display="none"):(urlcheckBox.checked=!0,filecontainer.style.display="none",urlcontainer.style.display="block")})),urlcheckBox.addEventListener("click",(function(){1==urlcheckBox.checked?(filecheckBox.checked=!1,filecontainer.style.display="none",urlcontainer.style.display="block"):(filecheckBox.checked=!0,filecontainer.style.display="block",urlcontainer.style.display="none")})),DepthWarmup();