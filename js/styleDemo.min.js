tf.setBackend("webgl"),tf.ENV.set("WEBGL_FORCE_F16_TEXTURES",!0),tf.enableProdMode();class MirrorPad extends tf.layers.Layer{static className="MirrorPad";constructor(e){super(e),this.pad0=e.padding[0],this.pad1=e.padding[1]}call(e,t){return e[0].mirrorPad([[0,0],this.pad0,this.pad1,[0,0]],"reflect")}}let model_transformer;tf.serialization.registerClass(MirrorPad);const ratio=.5625;var style_IMAGE_HEIGHT=512,style_IMAGE_WIDTH=Math.floor(style_IMAGE_HEIGHT*ratio),output_HEIGHT=512,output_WIDTH=Math.floor(output_HEIGHT*ratio),videoHeight=512,videoWidth=Math.floor(.75*videoHeight),de_canvas=document.getElementById("mask");const mean=tf.tensor3d([.485,.456,.406],[1,1,3]),std=tf.tensor3d([.229,.224,.225],[1,1,3]),scale=tf.scalar(255),dropdown_style_qual=document.getElementById("dropdown_style_qual"),mobile=isMobile();var style_type="mosaic_small",mode="user";function is_touch_device(){return"ontouchstart"in window||"onmsgesturechange"in window}if(!is_touch_device()&&!window.matchMedia("(max-device-width: 960px)").matches){style_IMAGE_HEIGHT=512,style_IMAGE_WIDTH=Math.floor(style_IMAGE_HEIGHT*ratio);dropdown_style_qual.textContent=style_vhigh.textContent}document.getElementById("files_style").addEventListener("change",(function(e){file_infer(e.target.files[0],document.getElementById("inpimg_style"),status_style,style_Demo)})),document.getElementById("style_files_btn").addEventListener("click",(function(e){file=document.getElementById("files_style").files[0],null==file?status_style.textContent="Status: File not found":file_infer(file,document.getElementById("inpimg_style"),status_style,style_Demo)})),document.getElementById("btn_style").addEventListener("click",(function(e){url_infer(document.getElementById("imagename_style"),document.getElementById("inpimg_style"),status_style,style_Demo)}));const model_lookup={mosaic_small:"/assets/mosaic6_style_literr_pruned_quant/model.json",mosaic:"/assets/mosaic_style_lite_quant/model.json",madhubani:"/assets/madhubani4_style_literr_pruned_quant/model.json",sketch:"/assets/sketch_style_literr_pruned_quant/model.json",feathers:"/assets/feathers_style_literr_pruned_quant/model.json"},Load_style_model=async e=>{model_transformer=await tf.loadLayersModel(model_lookup[e])},StyleWarmup=async()=>{status_style.textContent="Status: Loading...",await Load_style_model(style_type);let e=document.getElementById("inpimg_style");set_static_output_size(e),e.complete&&0!==e.naturalHeight?(style_Demo(e),e.style.display=""):e.onload=()=>{style_Demo(e),inpElement.style.display=""},document.getElementById("file-container").style.display=""},style_Demo=async e=>{status_style.textContent="Status: Loading image into model...";const t=tf.tidy(()=>{const t=tf.browser.fromPixels(e).toFloat();output_HEIGHT=t.shape[0],output_WIDTH=t.shape[1];const n=tf.image.resizeBilinear(t,[style_IMAGE_HEIGHT,style_IMAGE_WIDTH],!0).expandDims();status_style.textContent="Status: Model loaded! running inference";const o=model_transformer.predict(n).squeeze(0).clipByValue(0,255).div(scale);return tf.image.resizeBilinear(o,[output_HEIGHT,output_WIDTH],!0)});await tf.browser.toPixels(t,de_canvas),status_style.textContent="Status: Done!",t.dispose()},style_Demo_RT=async e=>{const t=tf.tidy(()=>{const t=tf.browser.fromPixels(e).toFloat(),n=tf.image.resizeBilinear(t,[style_IMAGE_HEIGHT,style_IMAGE_WIDTH],!0).expandDims(),o=model_transformer.predict(n).squeeze(0).clipByValue(0,255).div(scale);return tf.image.resizeBilinear(o,[output_HEIGHT,output_WIDTH],!0)});await tf.browser.toPixels(t,de_canvas),t.dispose()};let request;function detectInRealTime(e){de_canvas=document.getElementById("output");const t="rear"!=mode;de_canvas.width=output_WIDTH,de_canvas.height=output_HEIGHT;const n=de_canvas.getContext("2d");n.save(),async function o(){e.onloadeddata=()=>{camloaded=!0},camloaded&&(style_Demo_RT(e),t&&(n.scale(-1,1),n.translate(-videoWidth,0))),request=requestAnimationFrame(o)}()}var filecheckBox=document.getElementById("fileinput"),urlcheckBox=document.getElementById("urlinput"),filecontainer=document.getElementById("file-container"),urlcontainer=document.getElementById("url-container");let video;async function bindPage(){camloaded=!1;try{video=await loadVideo(mode)}catch(e){let t=document.getElementById("info");throw t.textContent="this browser does not support video capture,or this device does not have a camera",t.style.display="block",e}detectInRealTime(video)}function setmode(){mode=1==document.getElementById("camMode").checked?"rear":"user",1==document.getElementById("webcamc").checked&&(video.srcObject.getTracks().forEach((function(e){e.stop()})),cancelAnimationFrame(request),bindPage())}function webc(){var e=document.getElementById("imagec"),t=document.getElementById("webcamc"),n=document.getElementById("mainImage"),o=document.getElementById("mainVideo");if(1==t.checked)document.getElementById("camswitch").style.display="block",e.checked=!1,document.getElementById("dropdown_style_qual").textContent=document.getElementById("style_high").textContent,style_IMAGE_HEIGHT=style_res_lookup.style_high,style_IMAGE_WIDTH=Math.floor(style_IMAGE_HEIGHT*ratio),t_Width=document.getElementById("mainopt").clientWidth,t_Height=384,n.style.display="none",document.getElementById("main").style.display="block",o.style.display="block",apectWidth=.75*t_Height,output_WIDTH=apectWidth>t_Width?t_Width:apectWidth,output_HEIGHT=t_Height,camloaded=!1,bindPage();else{document.getElementById("camswitch").style.display="none",cancelAnimationFrame(request),video.srcObject.getTracks().forEach((function(e){e.stop()})),document.getElementById("output").getContext("2d").clearRect(0,0,output_WIDTH,output_HEIGHT),o.style.display="none",document.getElementById("main").style.display="none"}}function imagec(){var e=document.getElementById("imagec"),t=document.getElementById("webcamc"),n=document.getElementById("mainImage"),o=document.getElementById("mainVideo");1==e.checked?(1==t.checked&&(document.getElementById("camswitch").style.display="none",t.checked=!1,cancelAnimationFrame(request),video&&video.srcObject.getTracks().forEach((function(e){e.stop()}))),document.getElementById("main").style.display="block",n.style.display="block",o.style.display="none"):(n.style.display="none",document.getElementById("main").style.display="none")}function load_style(e){event.preventDefault(),document.getElementById("dropdown_style").textContent=document.getElementById(e).textContent,Load_style_model(style_type=e)}filecheckBox.addEventListener("click",(function(){1==filecheckBox.checked?(urlcheckBox.checked=!1,filecontainer.style.display="block",urlcontainer.style.display="none"):(urlcheckBox.checked=!0,filecontainer.style.display="none",urlcontainer.style.display="block")})),urlcheckBox.addEventListener("click",(function(){1==urlcheckBox.checked?(filecheckBox.checked=!1,filecontainer.style.display="none",urlcontainer.style.display="block"):(filecheckBox.checked=!0,filecontainer.style.display="block",urlcontainer.style.display="none")}));const style_res_lookup={style_low:192,style_medium:256,style_high:384,style_vhigh:512};function set_style_res(e){event.preventDefault(),document.getElementById("dropdown_style_qual").textContent=document.getElementById(e).textContent,style_IMAGE_HEIGHT=style_res_lookup[e],style_IMAGE_WIDTH=Math.floor(style_IMAGE_HEIGHT*ratio)}StyleWarmup();
