let model_sem_encoder,model_sem_decoder,model_transformer;tf.setBackend("webgl"),tf.ENV.set("WEBGL_CONV_IM2COL",!1),tf.ENV.set("WEBGL_PACK",!1),tf.webgl.forceHalfFloat();var segmentation_IMAGE_HEIGHT=512,segmentation_IMAGE_WIDTH=512,style_IMAGE_HEIGHT=384,style_IMAGE_WIDTH=384,output_HEIGHT=300,output_WIDTH=400,cors_api_url="https://cors-anywhere.herokuapp.com/";const dropdown_seg_qual=document.getElementById("dropdown_seg_qual"),seg_low=document.getElementById("seg_low"),seg_medium=document.getElementById("seg_medium"),seg_high=document.getElementById("seg_high"),dropdown_style_qual=document.getElementById("dropdown_style_qual"),style_low=document.getElementById("style_low"),style_medium=document.getElementById("style_medium"),style_high=document.getElementById("style_high"),style_vhigh=document.getElementById("style_vhigh"),mobile=isMobile();var mode="user";function is_touch_device(){return"ontouchstart"in window||"onmsgesturechange"in window}is_touch_device()||window.matchMedia("(max-device-width: 960px)").matches||(style_IMAGE_HEIGHT=512,style_IMAGE_WIDTH=512,dropdown_style_qual.textContent=style_vhigh.textContent),document.getElementById("files_style").addEventListener("change",(function(e){file_infer(e.target.files[0],document.getElementById("inpimg_style"),status_style,style_Demo)})),document.getElementById("style_files_btn").addEventListener("click",(function(e){file=document.getElementById("files_style").files[0],null==file?status_style.textContent="Status: File not found":file_infer(file,document.getElementById("inpimg_style"),status_style,style_Demo)})),document.getElementById("btn_style").addEventListener("click",(function(e){url_infer(document.getElementById("imagename_style"),document.getElementById("inpimg_style"),status_style,style_Demo)}));const Load_style_model=async e=>{model_transformer="madhubani"==e?await tf.loadLayersModel("/assets/tfjs_layers_style_lite_madhubani/model.json"):await tf.loadLayersModel("/assets/tfjs_layers_style_lite/model.json")},StyleWarmup=async()=>{status_style.textContent="Status: Loading...",Load_style_model(style_type),model_sem_encoder=await tf.loadLayersModel("/assets/tfjs_layers_sem_encoder_bi_quant/model.json"),model_sem_decoder=await tf.loadLayersModel("/assets/tfjs_layers_sem_decoder_pruned_quant/model.json");let e=document.getElementById("inpimg_style");set_static_output_size(e),e.complete&&0!==e.naturalHeight?(style_Demo(e),e.style.display=""):e.onload=()=>{style_Demo(e),inpElement.style.display=""},document.getElementById("file-container").style.display=""},style_Demo=async e=>{status_style.textContent="Status: Loading image into model...";const t=tf.tidy(()=>{output_WIDTH=e.clientWidth,output_HEIGHT=e.clientHeight;var t=tf.browser.fromPixels(e).toFloat();const n=tf.image.resizeBilinear(t,[style_IMAGE_HEIGHT,style_IMAGE_WIDTH],!0).expandDims(),o=tf.tensor3d([.485,.456,.406],[1,1,3]),l=tf.tensor3d([.229,.224,.225],[1,1,3]),s=tf.scalar(255);status_style.textContent="Status: Model loaded! running inference";const d=model_transformer.predict(n).squeeze(0).clipByValue(0,255).div(s);if("style_only"==output_type)return d;{const e=tf.image.resizeBilinear(t,[segmentation_IMAGE_HEIGHT,segmentation_IMAGE_WIDTH],!0),n=e.div(s),i=e.div(s).sub(o).div(l).expandDims(),a=model_sem_encoder.predict(i),c=tf.image.resizeBilinear(a[4],[64,64],!0),m=model_sem_decoder.predict(c),_=tf.image.resizeBilinear(m,[segmentation_IMAGE_HEIGHT,segmentation_IMAGE_WIDTH],!0).squeeze(0).argMax(2),u=tf.stack([_,_,_],2);if("masked_style"==output_type)return tf.image.resizeBilinear(d,[segmentation_IMAGE_HEIGHT,segmentation_IMAGE_WIDTH],!0).where(u.equal(15),n);if("masked_style_inverted"==output_type)return n.where(u.equal(15),tf.image.resizeBilinear(d,[segmentation_IMAGE_HEIGHT,segmentation_IMAGE_WIDTH],!0))}}),n=document.getElementById("mask");status_style.textContent="Status: Done!",tf.browser.toPixels(tf.image.resizeBilinear(t,[output_HEIGHT,output_WIDTH]),n),t.dispose()};let request;function detectInRealTime(e){console.log("running detectInRealTime!");const t=document.getElementById("output");t.getContext("2d");t.width=output_WIDTH,t.height=output_HEIGHT,async function t(){console.log("running DetectionFrame!"),e.onloadeddata=()=>{camloaded=!0},camloaded&&style_Demo(e),request=requestAnimationFrame(t)}()}var filecheckBox=document.getElementById("fileinput"),urlcheckBox=document.getElementById("urlinput"),filecontainer=document.getElementById("file-container"),urlcontainer=document.getElementById("url-container");let video;async function bindPage(){camloaded=!1;try{video=await loadVideo(mode)}catch(e){let t=document.getElementById("info");throw t.textContent="this browser does not support video capture,or this device does not have a camera",t.style.display="block",e}detectInRealTime(video)}function setmode(){mode=1==document.getElementById("camMode").checked?"rear":"user",1==document.getElementById("webcamc").checked&&(video.srcObject.getTracks().forEach((function(e){e.stop()})),cancelAnimationFrame(request),bindPage())}function webc(){var e=document.getElementById("imagec"),t=document.getElementById("webcamc"),n=document.getElementById("mainImage"),o=document.getElementById("mainVideo");if(1==t.checked)document.getElementById("camswitch").style.display="block",e.checked=!1,t_Width=document.getElementById("mainopt").clientWidth,t_Height=300,n.style.display="none",document.getElementById("main").style.display="block",o.style.display="block",apectWidth=4/3*t_Height,output_WIDTH=apectWidth>t_Width?t_Width:apectWidth,output_HEIGHT=t_Height,camloaded=!1,bindPage();else{document.getElementById("camswitch").style.display="none",cancelAnimationFrame(request),video.srcObject.getTracks().forEach((function(e){e.stop()})),document.getElementById("output").getContext("2d").clearRect(0,0,output_WIDTH,output_HEIGHT),o.style.display="none",document.getElementById("main").style.display="none"}}function imagec(){var e=document.getElementById("imagec"),t=document.getElementById("webcamc"),n=document.getElementById("mainImage"),o=document.getElementById("inpimg0"),l=document.getElementById("mainVideo");1==e.checked?(1==t.checked&&(document.getElementById("camswitch").style.display="none",t.checked=!1,cancelAnimationFrame(request),video.srcObject.getTracks().forEach((function(e){e.stop()}))),document.getElementById("main").style.display="block",n.style.display="block",l.style.display="none",o.src="/assets/demo_images/box_6109.jpg",ClassiferWarmup()):(n.style.display="none",document.getElementById("main").style.display="none")}filecheckBox.addEventListener("click",(function(){1==filecheckBox.checked?(urlcheckBox.checked=!1,filecontainer.style.display="block",urlcontainer.style.display="none"):(urlcheckBox.checked=!0,filecontainer.style.display="none",urlcontainer.style.display="block")})),urlcheckBox.addEventListener("click",(function(){1==urlcheckBox.checked?(filecheckBox.checked=!1,filecontainer.style.display="none",urlcontainer.style.display="block"):(filecheckBox.checked=!0,filecontainer.style.display="block",urlcontainer.style.display="none")}));const dropdown_output=document.getElementById("dropdown_output"),style_only=document.getElementById("style_only"),masked_style=document.getElementById("masked_style"),masked_style_inverted=document.getElementById("masked_style_inverted");var output_type="style_only";style_only.onclick=function(){event.preventDefault(),output_type="style_only",dropdown_output.textContent=style_only.textContent},masked_style.onclick=function(){event.preventDefault(),output_type="masked_style",dropdown_output.textContent=masked_style.textContent},masked_style_inverted.onclick=function(){event.preventDefault(),output_type="masked_style_inverted",dropdown_output.textContent=masked_style_inverted.textContent};const dropdown_style=document.getElementById("dropdown_style"),mosaic=document.getElementById("mosaic"),madhubani=document.getElementById("madhubani");var style_type="mosaic";mosaic.onclick=function(){event.preventDefault(),Load_style_model(style_type="mosaic"),dropdown_style.textContent=mosaic.textContent},madhubani.onclick=function(){event.preventDefault(),Load_style_model(style_type="madhubani"),dropdown_style.textContent=madhubani.textContent},seg_low.onclick=function(){event.preventDefault(),segmentation_IMAGE_HEIGHT=128,segmentation_IMAGE_WIDTH=128,dropdown_seg_qual.textContent=seg_low.textContent},seg_medium.onclick=function(){event.preventDefault(),segmentation_IMAGE_HEIGHT=256,segmentation_IMAGE_WIDTH=256,dropdown_seg_qual.textContent=seg_medium.textContent},seg_high.onclick=function(){event.preventDefault(),segmentation_IMAGE_HEIGHT=512,segmentation_IMAGE_WIDTH=512,dropdown_seg_qual.textContent=seg_high.textContent},style_low.onclick=function(){event.preventDefault(),style_IMAGE_HEIGHT=192,style_IMAGE_WIDTH=192,dropdown_style_qual.textContent=style_low.textContent},style_medium.onclick=function(){event.preventDefault(),style_IMAGE_HEIGHT=256,style_IMAGE_WIDTH=256,dropdown_style_qual.textContent=style_medium.textContent},style_high.onclick=function(){event.preventDefault(),style_IMAGE_HEIGHT=384,style_IMAGE_WIDTH=384,dropdown_style_qual.textContent=style_high.textContent},style_vhigh.onclick=function(){event.preventDefault(),style_IMAGE_HEIGHT=512,style_IMAGE_WIDTH=512,dropdown_style_qual.textContent=style_vhigh.textContent},StyleWarmup();