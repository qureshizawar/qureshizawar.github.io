let model_sem_encoder,model_sem_decoder,model_transformer;tf.setBackend("webgl"),tf.ENV.set("WEBGL_CONV_IM2COL",!1);var segmentation_IMAGE_HEIGHT=512,segmentation_IMAGE_WIDTH=512,style_IMAGE_HEIGHT=384,style_IMAGE_WIDTH=384,cors_api_url="https://cors-anywhere.herokuapp.com/";const dropdown_seg_qual=document.getElementById("dropdown_seg_qual"),seg_low=document.getElementById("seg_low"),seg_medium=document.getElementById("seg_medium"),seg_high=document.getElementById("seg_high"),dropdown_style_qual=document.getElementById("dropdown_style_qual"),style_low=document.getElementById("style_low"),style_medium=document.getElementById("style_medium"),style_high=document.getElementById("style_high"),style_vhigh=document.getElementById("style_vhigh");function is_touch_device(){return"ontouchstart"in window||"onmsgesturechange"in window}function style_file(e){if(status_style.textContent="Status: Fetching image...",window.File&&window.FileReader&&window.FileList&&window.Blob){var t=new FileReader;t.addEventListener("load",(function(e){const t=e.target.result;window.loadImage(t,(function(e){"error"===e.type?console.log("couldn't load image:",e):window.EXIF.getData(e,(function(){var t=window.EXIF.getTag(this,"Orientation"),n=window.loadImage.scale(e,{orientation:t||0,canvas:!0});let o=document.getElementById("inpimg_style");o.src=n.toDataURL(),o.onload=()=>style_Demo(o)}))}))})),t.readAsDataURL(e)}else console.log("The File APIs are not fully supported in this browser.")}is_touch_device()||window.matchMedia("(max-device-width: 960px)").matches||(style_IMAGE_HEIGHT=512,style_IMAGE_WIDTH=512,dropdown_style_qual.textContent=style_vhigh.textContent),document.getElementById("files_style").addEventListener("change",(function(e){style_file(e.target.files[0])})),document.getElementById("style_files_btn").addEventListener("click",(function(e){file=document.getElementById("files_style").files[0],null==file?status_style.textContent="Status: File not found":style_file(file)})),document.getElementById("btn_style").onclick=function(){status_style.textContent="Status: Fetching image...";let e=new URL(document.getElementById("imagename_style").value);var t=new XMLHttpRequest;t.open("GET",cors_api_url+e,!0),t.responseType="blob",t.send(),t.onload=function(){var e=new FileReader;e.readAsDataURL(t.response),e.onload=e=>{let t=document.getElementById("inpimg_style");t.src=e.target.result,t.onload=()=>style_Demo(t)}}};const Load_style_model=async e=>{model_transformer="madhubani"==e?await tf.loadLayersModel("/assets/tfjs_layers_style_lite_madhubani/model.json"):await tf.loadLayersModel("/assets/tfjs_layers_style_lite/model.json")},StyleWarmup=async()=>{status_style.textContent="Status: Loading...",Load_style_model(style_type),model_sem_encoder=await tf.loadLayersModel("/assets/tfjs_layers_sem_encoder_bi_quant/model.json"),model_sem_decoder=await tf.loadLayersModel("/assets/tfjs_layers_sem_decoder_pruned_quant/model.json");let e=document.getElementById("inpimg_style");e.complete&&0!==e.naturalHeight?(style_Demo(e),e.style.display=""):e.onload=()=>{style_Demo(e),e.style.display=""},document.getElementById("file-container").style.display=""},style_Demo=async e=>{status_style.textContent="Status: Loading image into model...";var t=0,n=0;const o=tf.tidy(()=>{var o=tf.browser.fromPixels(e).toFloat();const s=tf.image.resizeBilinear(o,[style_IMAGE_HEIGHT,style_IMAGE_WIDTH],!0).expandDims(),l=tf.tensor3d([.485,.456,.406],[1,1,3]),d=tf.tensor3d([.229,.224,.225],[1,1,3]),_=tf.scalar(255);status_style.textContent="Status: Model loaded! running inference";var a=performance.now();const i=model_transformer.predict(s);var m=performance.now();n=m-a;const r=i.squeeze(0).clipByValue(0,255).div(_);if("style_only"==output_type)return r;{const e=tf.image.resizeBilinear(o,[segmentation_IMAGE_HEIGHT,segmentation_IMAGE_WIDTH],!0),n=e.div(_),s=e.div(_).sub(l).div(d).expandDims();var y=performance.now();const a=model_sem_encoder.predict(s),i=tf.image.resizeBilinear(a[4],[64,64],!0),m=model_sem_decoder.predict(i);var u=performance.now();t=u-y;const c=tf.image.resizeBilinear(m,[segmentation_IMAGE_HEIGHT,segmentation_IMAGE_WIDTH],!0).squeeze(0).argMax(2),g=tf.stack([c,c,c],2);if("masked_style"==output_type)return tf.image.resizeBilinear(r,[segmentation_IMAGE_HEIGHT,segmentation_IMAGE_WIDTH],!0).where(g.equal(15),n);if("masked_style_inverted"==output_type)return n.where(g.equal(15),tf.image.resizeBilinear(r,[segmentation_IMAGE_HEIGHT,segmentation_IMAGE_WIDTH],!0))}});t_Width=document.getElementById("inpimg_style").clientWidth,t_Height=document.getElementById("inpimg_style").clientHeight;const s=document.getElementById("mask");status_style.textContent="Status: Done! inference took "+(t+n).toFixed(1)+" milliseconds.";performance.now();tf.browser.toPixels(tf.image.resizeBilinear(o,[t_Height,t_Width]),s);performance.now(),performance.now();o.dispose()},dropdown_output=document.getElementById("dropdown_output"),style_only=document.getElementById("style_only"),masked_style=document.getElementById("masked_style"),masked_style_inverted=document.getElementById("masked_style_inverted");var output_type="style_only";style_only.onclick=function(){event.preventDefault(),output_type="style_only",dropdown_output.textContent=style_only.textContent},masked_style.onclick=function(){event.preventDefault(),output_type="masked_style",dropdown_output.textContent=masked_style.textContent},masked_style_inverted.onclick=function(){event.preventDefault(),output_type="masked_style_inverted",dropdown_output.textContent=masked_style_inverted.textContent};const dropdown_style=document.getElementById("dropdown_style"),mosaic=document.getElementById("mosaic"),madhubani=document.getElementById("madhubani");var style_type="mosaic";mosaic.onclick=function(){event.preventDefault(),Load_style_model(style_type="mosaic"),dropdown_style.textContent=mosaic.textContent},madhubani.onclick=function(){event.preventDefault(),Load_style_model(style_type="madhubani"),dropdown_style.textContent=madhubani.textContent},seg_low.onclick=function(){event.preventDefault(),segmentation_IMAGE_HEIGHT=128,segmentation_IMAGE_WIDTH=128,dropdown_seg_qual.textContent=seg_low.textContent},seg_medium.onclick=function(){event.preventDefault(),segmentation_IMAGE_HEIGHT=256,segmentation_IMAGE_WIDTH=256,dropdown_seg_qual.textContent=seg_medium.textContent},seg_high.onclick=function(){event.preventDefault(),segmentation_IMAGE_HEIGHT=512,segmentation_IMAGE_WIDTH=512,dropdown_seg_qual.textContent=seg_high.textContent},style_low.onclick=function(){event.preventDefault(),style_IMAGE_HEIGHT=192,style_IMAGE_WIDTH=192,dropdown_style_qual.textContent=style_low.textContent},style_medium.onclick=function(){event.preventDefault(),style_IMAGE_HEIGHT=256,style_IMAGE_WIDTH=256,dropdown_style_qual.textContent=style_medium.textContent},style_high.onclick=function(){event.preventDefault(),style_IMAGE_HEIGHT=384,style_IMAGE_WIDTH=384,dropdown_style_qual.textContent=style_high.textContent},style_vhigh.onclick=function(){event.preventDefault(),style_IMAGE_HEIGHT=512,style_IMAGE_WIDTH=512,dropdown_style_qual.textContent=style_vhigh.textContent},StyleWarmup();