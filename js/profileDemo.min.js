let model_sem_encoder,model_sem_decoder,blur_kernel;tf.setBackend("webgl"),tf.ENV.set("WEBGL_CONV_IM2COL",!1),tf.ENV.set("WEBGL_PACK",!1),tf.ENV.set("WEBGL_FORCE_F16_TEXTURES",!0),tf.enableProdMode();var blur_bg=!1;let model_transformer;var segmentation_IMAGE_HEIGHT=448,segmentation_IMAGE_WIDTH=448,ratio=.5625,style_IMAGE_HEIGHT=512,style_IMAGE_WIDTH=Math.floor(style_IMAGE_HEIGHT*ratio),output_HEIGHT=512,output_WIDTH=Math.floor(output_HEIGHT*ratio),use_bg=!0,de_canvas=document.getElementById("mask");const mobile=isMobile();var mode="user";is_touch_device()||window.matchMedia("(max-device-width: 960px)").matches||(ratio=1,style_IMAGE_HEIGHT=512,style_IMAGE_WIDTH=Math.floor(style_IMAGE_HEIGHT*ratio),dropdown_style_qual.textContent=style_high.textContent),document.getElementById("bg_files").addEventListener("change",(function(e){file_load(e.target.files[0],document.getElementById("bg_img"),status_style)})),document.getElementById("bg_url").addEventListener("click",(function(e){url_load(document.getElementById("bg_imagename"),document.getElementById("bg_img"),status_style)})),document.getElementById("files_style").addEventListener("change",(function(e){file_infer(e.target.files[0],document.getElementById("inpimg_style"),status_style,style_Demo)})),document.getElementById("style_files_btn").addEventListener("click",(function(e){file=document.getElementById("files_style").files[0],null==file?status_style.textContent="Status: File not found":file_infer(file,document.getElementById("inpimg_style"),status_style,style_Demo)})),document.getElementById("btn_style").addEventListener("click",(function(e){url_infer(document.getElementById("imagename_style"),document.getElementById("inpimg_style"),status_style,style_Demo)}));const model_lookup={mosaic_small:"/assets/mosaic6_style_literr_pruned_quant/model.json",mosaic:"/assets/mosaic_style_lite_quant/model.json",madhubani:"/assets/madhubani4_style_literr_pruned_quant/model.json",sketch:"/assets/sketch_style_literr_pruned_quant/model.json",feathers:"/assets/feathers_style_literr_pruned_quant/model.json",oil:"/assets/oil1_style_literr_pruned_quant/model.json"};var curr_style;const Load_style_model=async e=>{curr_style=e,model_transformer=await tf.loadLayersModel(model_lookup[e])},StyleWarmup=async()=>{status_style.textContent="Status: Loading...",Load_style_model(style_type),model_seg=await tf.loadLayersModel("/assets/mobile3_seg_bi_quant/model.json"),blur_kernel=await tf.loadLayersModel("/assets/gaus_11/model.json"),bg_blur_kernel=await tf.loadLayersModel("/assets/gaus_21_3/model.json");let e=document.getElementById("inpimg_style");set_static_output_size(e),e.complete&&0!==e.naturalHeight?(style_Demo(e),e.style.display=""):e.onload=()=>{style_Demo(e),inpElement.style.display=""},document.getElementById("file-container").style.display=""},style_Demo=async e=>{status_style.textContent="Status: Loading image into model...",document.getElementById("download").style.display="none";let t=document.getElementById("bg_img");var l=tf.tidy(()=>{const l=tf.tensor3d([.485,.456,.406],[1,1,3]),n=tf.tensor3d([.229,.224,.225],[1,1,3]),s=tf.scalar(255);var o=tf.browser.fromPixels(e).toFloat(),i=!1;if(use_bg&&t.complete&&0!==t.naturalHeight){bg=tf.browser.fromPixels(t).toFloat();i=!0}if(output_HEIGHT=o.shape[0],output_WIDTH=o.shape[1],"style_only"==output_type&&0==use_bg&&0==blur_bg){const e=tf.image.resizeBilinear(o,[style_IMAGE_HEIGHT,style_IMAGE_WIDTH],!0).expandDims();status_style.textContent="Status: Model loaded! running inference";const t=model_transformer.predict(e).squeeze(0).clipByValue(0,255).div(s);return tf.image.resizeBilinear(t,[output_HEIGHT,output_WIDTH],!0)}{const e=tf.image.resizeBilinear(o,[segmentation_IMAGE_HEIGHT,segmentation_IMAGE_WIDTH],!0).div(s).sub(l).div(n).transpose([2,0,1]).expandDims(),t=tf.ones([output_HEIGHT,output_WIDTH]),u=model_seg.predict(e).transpose([0,2,3,1]),_=tf.image.resizeBilinear(u,[output_HEIGHT,output_WIDTH],!1).squeeze(0).argMax(2),c=t.where(_.equal(1),0).expandDims(0).expandDims(3),m=blur_kernel.predict(c).squeeze(0).squeeze(2),y=m.sub(1).abs(),g=tf.stack([m,m,m],2),p=tf.stack([y,y,y],2);if("masked_background"==output_type&&0==use_bg&&1==blur_bg){const e=bg_blur_kernel.predict(o.expandDims(0)).squeeze(0);return o.div(s).mul(g).add(e.div(s).mul(p)).clipByValue(0,1)}if("masked_background"==output_type&&use_bg&&1==i){var r=tf.image.resizeBilinear(bg,[output_HEIGHT,output_WIDTH],!0);return blur_bg&&(r=bg_blur_kernel.predict(r.expandDims(0)).squeeze(0)),o.div(s).mul(g).add(r.div(s).mul(p)).clipByValue(0,1)}if("style_only"==output_type){const e=tf.image.resizeBilinear(o,[style_IMAGE_HEIGHT,style_IMAGE_WIDTH],!0).expandDims(),t=tf.image.resizeBilinear(g,[style_IMAGE_HEIGHT,style_IMAGE_WIDTH],!0),l=tf.image.resizeBilinear(p,[style_IMAGE_HEIGHT,style_IMAGE_WIDTH],!0).expandDims();if(use_bg&&1==i){var a=tf.image.resizeBilinear(bg,[style_IMAGE_HEIGHT,style_IMAGE_WIDTH],!0);blur_bg&&(a=bg_blur_kernel.predict(a.expandDims(0)).squeeze(0));const n=e.mul(t).add(a.mul(l)),o=model_transformer.predict(n).squeeze(0).clipByValue(0,255).div(s);return tf.image.resizeBilinear(o,[output_HEIGHT,output_WIDTH],!0)}if(blur_bg){const n=bg_blur_kernel.predict(e).squeeze(0),o=e.mul(t).add(n.mul(l)),i=model_transformer.predict(o).squeeze(0).clipByValue(0,255).div(s);return tf.image.resizeBilinear(i,[output_HEIGHT,output_WIDTH],!0)}}else{if("masked_style"==output_type){const e=tf.image.resizeBilinear(o,[style_IMAGE_HEIGHT,style_IMAGE_WIDTH],!0).expandDims(),t=model_transformer.predict(e).squeeze(0).clipByValue(0,255).div(s),l=tf.image.resizeBilinear(t,[output_HEIGHT,output_WIDTH],!0);if(use_bg&&1==i){r=tf.image.resizeBilinear(bg,[output_HEIGHT,output_WIDTH],!0);return blur_bg&&(r=bg_blur_kernel.predict(r.expandDims(0)).squeeze(0)),l.mul(g).add(r.mul(p).div(s)).clipByValue(0,1)}if(blur_bg){const e=bg_blur_kernel.predict(e.expandDims(0)).squeeze(0)}return l.mul(g).add(o.mul(p).div(s)).clipByValue(0,1)}if("masked_style_inverted"==output_type){if(use_bg&&1==i){const e=tf.image.resizeBilinear(bg,[style_IMAGE_HEIGHT,style_IMAGE_WIDTH],!0).expandDims(),t=model_transformer.predict(e).squeeze(0).clipByValue(0,255).div(s);var d=tf.image.resizeBilinear(t,[output_HEIGHT,output_WIDTH],!0);return blur_bg&&(d=bg_blur_kernel.predict(d.expandDims(0)).squeeze(0)),o.div(s).mul(g).add(d.mul(p)).clipByValue(0,1)}{const e=tf.image.resizeBilinear(o,[style_IMAGE_HEIGHT,style_IMAGE_WIDTH],!0).expandDims(),t=model_transformer.predict(e).squeeze(0).clipByValue(0,255).div(s);d=tf.image.resizeBilinear(t,[output_HEIGHT,output_WIDTH],!0);return blur_bg&&(d=bg_blur_kernel.predict(d.expandDims(0)).squeeze(0)),o.div(s).mul(g).add(d.mul(p)).clipByValue(0,1)}}}}return o.div(s)});"masked_background"!==output_type&&"sketch"==curr_style&&(l=tf.tidy(()=>{const e=tf.tensor3d([.2126,.7152,.0722],[1,1,3]);return l.mul(e).sum(2)})),await tf.browser.toPixels(l,de_canvas);performance.now();status_style.textContent="Status: Done!",document.getElementById("download").style.display="block",l.dispose()};function bg_load(e){event.preventDefault(),document.getElementById("bg_dropdown_out").textContent=document.getElementById(e).textContent,document.getElementById("bg_img").src="assets/demo_images/"+e+".jpg"}var output_type="style_only";function set_output(e){event.preventDefault(),document.getElementById("dropdown_output").textContent=document.getElementById(e).textContent,output_type=e}var style_type="mosaic";function load_style(e){event.preventDefault(),document.getElementById("dropdown_style").textContent=document.getElementById(e).textContent,Load_style_model(style_type=e)}const seg_res_lookup={seg_low:256,seg_medium:380,seg_high:480};function set_seg_res(e){event.preventDefault(),document.getElementById("dropdown_seg_qual").textContent=document.getElementById(e).textContent,segmentation_IMAGE_HEIGHT=seg_res_lookup[e],segmentation_IMAGE_WIDTH=seg_res_lookup[e]}const style_res_lookup={style_low:256,style_medium:384,style_high:512};function set_style_res(e){event.preventDefault(),document.getElementById("dropdown_style_qual").textContent=document.getElementById(e).textContent,style_IMAGE_HEIGHT=style_res_lookup[e],style_IMAGE_WIDTH=Math.floor(style_IMAGE_HEIGHT*ratio)}var filecheckBox=document.getElementById("fileinput"),urlcheckBox=document.getElementById("urlinput"),filecontainer=document.getElementById("file-container"),urlcontainer=document.getElementById("url-container");filecheckBox.addEventListener("click",(function(){1==filecheckBox.checked?(urlcheckBox.checked=!1,filecontainer.style.display="block",urlcontainer.style.display="none"):(urlcheckBox.checked=!0,filecontainer.style.display="none",urlcontainer.style.display="block")})),urlcheckBox.addEventListener("click",(function(){1==urlcheckBox.checked?(filecheckBox.checked=!1,filecontainer.style.display="none",urlcontainer.style.display="block"):(filecheckBox.checked=!0,filecontainer.style.display="block",urlcontainer.style.display="none")}));var bg_blurcheckBox=document.getElementById("blur_bg"),bg_usecheckBox=document.getElementById("bg_use"),bg_selectcheckBox=document.getElementById("bg_selectinput"),bg_filecheckBox=document.getElementById("bg_fileinput"),bg_urlcheckBox=document.getElementById("bg_urlinput"),bg_dropdown=document.getElementById("dropdown_bg"),bg_filecontainer=document.getElementById("bg_file-container"),bg_urlcontainer=document.getElementById("bg_url-container"),bg_urlbtn=document.getElementById("bg_url");function _defineProperty(e,t,l){return t in e?Object.defineProperty(e,t,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[t]=l,e}bg_blurcheckBox.addEventListener("click",(function(){blur_bg=1==bg_blurcheckBox.checked})),bg_usecheckBox.addEventListener("click",(function(){1==bg_usecheckBox.checked?(document.getElementById("bg_table").style.display="block",use_bg=!0):(document.getElementById("bg_table").style.display="none",use_bg=!1)})),bg_selectcheckBox.addEventListener("click",(function(){1==bg_selectcheckBox.checked&&(bg_filecheckBox.checked=!1,bg_urlcheckBox.checked=!1,bg_dropdown.style.display="block",bg_filecontainer.style.display="none",bg_urlcontainer.style.display="none",bg_urlbtn.style.display="none")})),bg_filecheckBox.addEventListener("click",(function(){1==bg_filecheckBox.checked&&(bg_selectcheckBox.checked=!1,bg_urlcheckBox.checked=!1,bg_dropdown.style.display="none",bg_filecontainer.style.display="block",bg_urlcontainer.style.display="none",bg_urlbtn.style.display="none")})),bg_urlcheckBox.addEventListener("click",(function(){1==bg_urlcheckBox.checked&&(bg_selectcheckBox.checked=!1,bg_filecheckBox.checked=!1,bg_dropdown.style.display="none",bg_filecontainer.style.display="none",bg_urlcontainer.style.display="block",bg_urlbtn.style.display="block")})),download_img=function(e){var t=document.getElementById("mask").toDataURL("image/jpg");e.href=t};class MirrorPad extends tf.layers.Layer{constructor(e){super(e),this.pad0=e.padding[0],this.pad1=e.padding[1]}call(e,t){return e[0].mirrorPad([[0,0],this.pad0,this.pad1,[0,0]],"reflect")}}_defineProperty(MirrorPad,"className","MirrorPad"),tf.serialization.registerClass(MirrorPad);class UpSampling2Dcustom extends tf.layers.Layer{constructor(e){super(e),this.size0=e.size[0],this.size1=e.size[1],this.dataFormat=e.dataFormat}call(e,t){const l=e[0].shape;return"channelsFirst"==this.dataFormat?tf.image.resizeBilinear(e[0].transpose([0,2,3,1]),[this.size0*l[2],this.size1*l[3]],!1,!0).transpose([0,3,1,2]):tf.image.resizeBilinear(e[0],[this.size0*l[2],this.size1*l[3]],!1,!0)}}_defineProperty(UpSampling2Dcustom,"className","UpSampling2Dcustom"),tf.serialization.registerClass(UpSampling2Dcustom);